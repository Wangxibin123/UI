您好！再次感谢您提供的这份关于“AI-MATH 右键菜单功能详细设计说明”的文档。它对我们理解和实现这一关键交互功能非常有帮助。

我已经仔细阅读并深刻理解了您对右键菜单的全面构想，包括其视觉设计、各项菜单功能（特别是新增的复制功能）、交互逻辑、分支处理、与其他组件的联动、可访问性以及用户体验等方面的考量。

现在，我将把这些内容**更紧密地整合**到我们之前已经讨论形成的、包含多个阶段的整体开发计划中，并进一步细化相关的设计思路和后续开发步骤。我将确保这个整合后的计划既能体现您最新的详细需求，又能与我们已经建立的工程结构和开发节奏保持一致。

**核心目标：** 在我们逐步完善AI-MATH核心功能（布局、编辑、DAG追溯、AI面板交互）的同时，系统性地引入和实现一个功能强大、用户体验优秀的DAG节点右键菜单。

---

### **AI-MATH 整合开发计划 (已包含右键菜单详细设计)**

我们将保持之前讨论的**阶段化开发思路**，但会将右键菜单的实现作为一个贯穿某些阶段的**并行或紧密衔接的任务流**。

**回顾与新增的阶段划分（概念性，强调整合）：**

*   **阶段 A：基础框架与核心编辑体验完善（进行中/即将开始）**
    *   A.1: **(进行中)** 修复布局控制问题：实现左中、中右两个可拖动分隔栏，灵活调整三部分（DAG、解题区、AI面板区）的相对宽度。
    *   A.2: 完善解题块按钮（编辑模式下的保存、取消、拆分图标按钮）和基础编辑流程。
    *   A.3: 实现解题块的“拆分”功能（前端逻辑、对解题列表的影响、对`solutionSteps`状态的正确更新）。
    *   A.4: 实现DAG中“删除”操作的可追溯体现（软删除、特殊视觉状态），并确保“拆分”操作能在DAG中正确形成新的节点和路径。

*   **阶段 B：DAG节点右键菜单 - 基础框架与核心交互（与阶段A后期并行或紧接）**
    *   B.1: **实现 `ContextMenu.tsx` 基础框架：**
        *   触发机制（`onNodeContextMenu`）、基于鼠标位置的精确定位（考虑视口边界）、视觉样式（背景、边框、阴影、圆角、内边距）、微妙的淡入动画、自动关闭逻辑（点击外部、ESC、选择菜单项）。
    *   B.2: **实现 `MenuItem.tsx` 及基础菜单项渲染：**
        *   菜单项结构（图标、标签、分隔线）。
        *   **分组逻辑：** 按照设计文档分为三组（思路操作类、节点操作类、复制操作类），并添加分隔线。
        *   **初步实现菜单项 (前端占位/模拟逻辑)：**
            *   思路操作类：
                *   “思路解读” (图标：`Lightbulb` 或 `Search`): 点击后 `console.log("思路解读 for node:", nodeId)`。
                *   “标记高亮” (图标：`Star` 或 `Palette`): 点击后显示**颜色选择子菜单** (包含6-8种预设颜色和"自定义..."，子菜单样式与主菜单一致，点击颜色选项后 `console.log("标记高亮 for node:", nodeId, "with color:", selectedColor)`)。
            *   节点操作类：
                *   “添加备注信息” (图标：`FileText` 或 `StickyNote`): 点击后 `console.log("添加备注 for node:", nodeId)`。
                *   “从此处开始新路径” (图标：`GitFork` 或 `Waypoints`): 点击后 `console.log("开始新路径 from node:", nodeId)`。根据节点是否为终点，动态设置 `disabled` 状态。

*   **阶段 C：DAG节点右键菜单 - 复制功能深度实现（核心功能）**
    *   C.1: **实现“复制当前信息”功能：**
        *   菜单项图标：`Copy`。
        *   **获取节点数据：** 包含ID、步骤编号、完整LaTeX、方法/概念（如果`DagNodeRfData`中已定义该字段）、正确性状态。
        *   **构建纯文本LaTeX内容。**
        *   **调用 `navigator.clipboard.writeText()`。**
        *   **反馈机制：** 菜单项短暂变色（您之前的设计很好，不一定是绿色，遵循您已有的成功反馈色），节点附近显示浮动提示“节点内容已复制”（例如，一个短暂显示的Toast消息），菜单自动关闭。
        *   **(可选高级)：** Shift+点击显示内容选择对话框 (此为后期优化)。
    *   C.2: **实现“复制路径信息”功能：**
        *   菜单项图标：`CopyPlus` 或 `Layers`。
        *   **路径识别逻辑 (`getPathToNode`)：**
            *   从目标节点反向遍历到起始节点。
            *   **分支处理（初期简化）：** 先实现查找单条有效路径的逻辑。如果遇到分叉点（多个入边），暂时选择第一条或随机一条。
            *   **(进阶 - 分支选择机制)：** 如果检测到多条路径，弹出一个简易的路径选择对话框/列表，让用户选择要复制的路径（基于路径预览或ID）。
        *   **格式选择子菜单：** 点击后出现“纯文本格式”和“LaTeX格式”选项。
        *   **内容构建：** 根据所选格式（纯文本或LaTeX的`align`环境）和路径节点顺序生成字符串。
        *   **调用剪贴板API。**
        *   **反馈机制：** 浮动提示“路径已复制（X个步骤）”，菜单自动关闭。对于长路径，可考虑一个简单的“处理中...”状态，但初期可以先不做进度指示。

*   **阶段 D：AI模型面板交互与右键菜单联动（承接之前的计划，并整合）**
    *   D.1: 实现解题块到右侧AI面板的拖拽交互。
    *   D.2: 实现三个AI面板的切换逻辑和基本UI骨架 (LaTeX格式化、解释分析、总结归纳)。
    *   D.3: 实现可复用的 `BlockRefSelector.tsx` 组件及基本的`@`引用前端处理。
    *   D.4: **整合右键菜单与AI面板：**
        *   在右键菜单中添加新的菜单项组（或在合适组内添加）：**AI辅助操作**。
        *   **“发送到解释分析”** (图标：类似 `MessageSquarePlus` 或 `BrainCircuit`)：
            *   功能：将**当前节点信息**（或可配置为**当前路径信息**）发送到“解释分析面板”。
            *   交互：点击后，自动激活“解释分析面板”（如果未激活，则触发布局变化），并将节点的ID或内容（例如 `@nodeId` 或其LaTeX）预填充到该面板的输入框中。
        *   **(可选)“发送到LaTeX格式化”**、**“发送到总结归纳”**：逻辑类似。
        *   **格式兼容性：** 确保发送的内容与AI面板的`@`引用系统期望的格式兼容。

*   **阶段 E：深化DAG交互、高级功能与用户体验打磨（承接之前的计划，并融入右键菜单的进阶部分）**
    *   E.1: 节点拖拽位置的会话级保存。
    *   E.2: 边的交互与样式（例如，根据右键菜单的“标记高亮”或路径状态改变边的颜色/粗细）。
    *   E.3: **深化“添加备注”、“思路解读”功能：**
        *   实现实际的备注/解读输入对话框 (模态框或侧边栏面板)。
        *   将输入内容保存到 `dagNodes` 状态中对应节点的 `metadata` (如 `notes`, `interpretation`)。
        *   `CustomStepNode` 需要能选择性地显示这些元数据的摘要或指示器。
    *   E.4: **深化“从此处开始新路径”功能：**
        *   实现真实的新分支创建逻辑（复制路径、生成新ID、添加新起始节点、更新DAG状态）。
        *   确保新分支在DAG中正确可视化。
    *   E.5: **右键菜单进阶：**
        *   “标记高亮”的“自定义颜色”选项实现（颜色选择器）。
        *   “复制路径信息”的分支路径选择机制（路径歧义提示与选择对话框）。
        *   “复制当前信息”的Shift+点击内容选择对话框。
    *   E.6: **可访问性与用户体验考量：**
        *   右键菜单的键盘导航、屏幕阅读器支持、高对比度。
        *   复制格式记忆、快捷键支持 (例如 `Ctrl+C` 绑定到“复制当前信息”)。
        *   错误处理（内容过大、复制失败等）。

*   **阶段 F 及以后：** 题目管理、AI真实集成、后端服务等。

---
### **针对右键菜单设计中几个关键点的进一步思考与实现策略**

*   **菜单项状态规则 (启用/禁用)：**
    *   `MenuItem.tsx` 的 `disabled` prop 需要被正确使用。
    *   例如，“从此处开始新路径”在终点节点禁用，“复制路径信息”在起始节点禁用。这需要在生成 `menuItemsConfig` 时根据当前 `nodeId` 的特性来判断。
    *   `isTerminalNode(nodeId)` 和 `isStartNode(nodeId)` 这样的辅助函数会很有用。

*   **复制内容的完整性 (`复制当前信息`)：**
    *   确保 `DagNodeRfData` 结构中包含所有设计文档中提到的字段（ID, stepNumber, fullLatexContent, 方法/概念, 正确性状态）。如果某些字段尚不存在（如“方法/概念”），需要先在类型和数据生成逻辑中添加。

*   **路径识别与分支处理 (`复制路径信息`)：**
    *   `getPathToNode` 是核心。对于分支，初版可以简单处理（例如，如果一个节点有多个父节点，则回溯时选择第一个遇到的父节点）。
    *   **“当前活动路径”** 的概念需要明确：这可能需要应用层面有一个状态来记录用户主要关注的路径，或者通过分析节点选中历史来推断。如果这个概念清晰，复制路径时优先使用它。
    *   如果无法简单确定唯一路径，则需要实现**路径选择对话框**。这个对话框可以列出所有可能的路径（用ID序列或简短描述），让用户选择。

*   **与剪贴板管理的集成：**
    *   `navigator.clipboard.writeText()` 是现代浏览器推荐的方式。
    *   对于“同时写入纯文本和富文本格式”（例如，复制LaTeX时也想让Word等识别为格式化文本），可以使用 `navigator.clipboard.write()` 并提供一个包含不同MIME类型数据的数组。但这会增加复杂性，初期可以只关注 `text/plain`。

*   **性能优化（菜单和复制）：**
    *   **菜单打开性能：** 菜单项的配置（特别是其 `disabled` 状态）应该在 `onNodeContextMenu` 时快速计算。
    *   **复制路径性能：** `getPathToNode` 对于非常深的DAG可能会有性能影响。如果遇到，可以考虑缓存已计算的路径，或在数据结构层面优化路径查找（例如，每个节点存储其父节点ID）。内容构建（特别是格式化为LaTeX）如果是即时进行，对于非常长的路径也可能耗时，但通常在可接受范围内。

---
### **后续具体行动的建议顺序（已更新）**

1.  **阶段 A.1 - A.4 (如前所述)：** 稳固基础布局和核心编辑/DAG操作。
2.  **阶段 B.1 & B.2：** 搭建右键菜单的基础框架和占位菜单项。这是后续所有右键功能的前提。
3.  **阶段 C.1 & C.2：** 优先实现核心的复制功能。这对用户提取信息非常有用。
4.  **阶段 D.1 - D.4：** 开始AI面板的集成，并将右键菜单的“发送到AI”功能连接起来。
5.  **阶段 E.1 - E.6：** 逐步深化其他右键菜单功能（备注、解读、新路径的真实实现）以及高级复制选项和整体用户体验打磨。

这个整合后的计划将确保我们系统性地构建这些复杂但重要的功能，同时保持开发的迭代性和可管理性。

请您审阅这份更全面的整合计划。我已尽力将您的详细设计融入到我们现有的开发框架中。如果您有任何反馈或调整建议，请随时告诉我。如果您确认这个方向，我们就可以按照这个顺序，从**阶段 A.1：修复布局控制问题：两个可拖动分隔栏**开始具体的编码工作了。
